{% extends "base.html" %}

{% block javascript %}
<script>
	var newURL = window.location.protocol + "//" + window.location.host + "/" + window.location.pathname + window.location.search
	var searchURL = window.location.search
	var searchArray = searchURL.split('=');
	// console.log(newURL)
	console.log(searchURL)
	console.log(searchArray[1])
</script>
{% endblock %}

<script>
{% block jquery %}

function setPrice(){
	var price = $(".variation_select option:selected").attr("data-price")
	var sale_price = $(".variation_select option:selected").attr("data-sale-price")
	if (sale_price != "" && sale_price != "None" && sale_price != null ) {
	$("#price").html("<h3>$" + sale_price + " <small class='og-price'>" + price  + "</small></h3>");
	} else {
	$("#price").html(price);
	}
}
setPrice()
$(".variation_select").change(function(){
	setPrice()
	var img = $(".variation_select option:selected").attr("data-img")
	$("#img").attr("src", img);
	var inv = $(".variation_select option:selected").attr("data-inv")
	if (inv != 0 && inv != "None" && inv != null ) {
	$("#var-inventory").html("<p class='text-muted'>Pick Up Today <span class='green-qty-text'>In Stock</span></p>")
	$("#submit-btn").removeClass('disabled invisible')
	} else {
	$("#var-inventory").html("<p class='text-muted'>Pick Up Today <span class='unavailable-text'>Not In Stock</span></p>")
	$("#submit-btn").addClass('disabled invisible')
	}
})


// ajax add to cart
$("#submit-btn").click(function(event){
	event.preventDefault();
	var formData = $("#add-form").serialize();
	console.log(formData);
	$.ajax({
		type: "GET", // "POST"
		url: "{% url 'cart' %}",
		data: formData,
		success: function(data) {
			showFlashMessage(data.flash_message);
			console.log("show flash");
			updateCartItemCount();
		}, 
		error: function(response, error) {
			// console.log(response)
			// console.log(error)
			$("#add-form").submit()
		}
	})
	// $("#add-form").submit()
})




{% endblock %}
</script>


{% block content %}

{% url 'products' as product_list_url %}
{% url 'products:product-variations-list' as product_variations_list_url %}

	<div class='row mt-3 mb-3'>
		<div class='col-12'>
			<nav aria-label="breadcrumb">
	  			<ol class="breadcrumb bg-light">
	    			<li class="breadcrumb-item"><a href="/">Home</a></li>
	    			<li class="breadcrumb-item" aria-current="products"><a href="{{ product_variations_list_url }}">Products</a></li>
	    			<li class="breadcrumb-item active" aria-current="{{ obj.get_absolute_url }}">{{ object.title }}</li>
	  			</ol>
			</nav>
		</div>	
	</div>

<div class='row'>
	<div class='col-sm-8'>
		<h2 class='title-heavy-txt'>{{ object.title }}{% if request.user.is_staff %}<span class='float-right'><a class='btn btn-sm btn-danger' href="{% url 'products:product_image' pk=object.pk %}">Set Image</a><a class='btn btn-sm btn-warning' href="{% url 'product_inventory' pk=object.pk %}">Inventory</a></span>{% endif %}</h2>

		{% if object.get_image_url %}
		<div>
		<img id='img' class='img-fluid' src='{{ object.variation_set.first.get_var_image_url }}' />
		</div>
		{% endif %}

		<div class='product-detail-big'>
			<h5>Details</h5>
			<p class='lead'>
			{{ object.description }}
			</p>
		</div>
	</div>


	<!-- Product Sidebar -->
	<div class='col-sm-4'>
	<!-- <p class='shipping-cla text-uppercase'>Ships in 1-2 days</p> -->
	 <p id='var-inventory' class='text-muted'>Pick Up Today
	{% if product.variation_set.first.inventory > 0 %}
	<span class='green-qty-text'>In Stock</span>	
	{% else %}
	 <span class='unavailable-text'>Not in Stock</span>
	{% endif %}
	</p>

	<form id='add-form' method='GET' action="{% url 'cart' %}">
	<p id='jquery-message' class='lead'>
		
	</p>


	{% if object.variation_set.count > 1 %}
	<h3 id='price'>${{ object.variation_set.first.price }}</h3>

	<select name='item' class='form-control variation_select'>
		{% for vari_obj in object.variation_set.all %}
			<option data-sale-price="{{ vari_obj.sale_price }}"  data-inv="{{ vari_obj.inventory }}" data-img="{{ vari_obj.get_var_image_url }}" data-price="{{ vari_obj.price }}" value="{{ vari_obj.id }}">{{ vari_obj.title }}</option>
		{% endfor %}
	</select>
	{% else %}
	<input type="hidden" name='item' value='{{ object.variation_set.first.id }}' />
		<h3 id='price'>{% if object.variation_set.first.sale_price %}
		${{ object.variation_set.first.sale_price  }}
		<small class='og-price'>{{ object.variation_set.first.price }}</small>
		{% else %}
		
		${{ object.variation_set.first.price }}
		{% endif %}
		</h3>
		<p class='text-muted'>{{ object.variation_set.first.title }}</p>

	{% endif %}
	<br/>
	<input class='form-control' type='number' name='qty' value='1' />
	<br/>
	<input id='submit-btn' type='submit' value='Add to Cart' class='btn btn-primary' />
	</form>

	<br/>
	<hr/>
	<div class='product-detail-small'>
		<h5>Details</h5>
		<p class='lead'>
			{{ object.description }}
			</p>
		<hr/>
	</div>
	<p>
	Share<br/>
	<span class='share-bigger'>
		<a href="#">
		<i class="fab fa-facebook-square"></i></a>

		<a href="#">
		<i class="fab fa-twitter"></i></a>
		<a href='#'><i class="fab fa-instagram"></i></a>
	</span>
	</p>
	<hr/>
	<h4 class='mb-3'>Related Products</h4>

		<div class='row'>
				{% for product in related %}

					<div class='col-xs-6 col-sm-6 col-md-6'>
						{% include "products/product_thumbnail.html" with product=product price="True" %}
					</div>
					{% cycle '' '</div><div class="row">' %}
				{% endfor %}

		</div>
	</div>

	<!-- End Product Sidebar -->
</div>

{% endblock %}